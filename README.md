<<<<<<< HEAD
# A bit of background
Sometime around September 2018, a customer approached us (the company I was working for at the time) to help automate their operations as much as possible in order to improve the overall productivity of their pig ranch, which was in dire need of some TLC - specifically, major mechanical changes and upgrades. Minimizing human interaction with the system was the ultimate goal, as their employees were still using the old-fashioned 'pencil and paper' method to track of the forage that was produced at their local mill and its subsequent distribution in the pigs ranch. This outdated approach was obviously prone to errors (mostly cos of human factor), hence the dire need for the upgrades and a better monitoring of the entire process.
=======
# About the app
In initial release I've used Visual Studio 2017 Community Edition to put together a few things to automate the process of taking the raw logs from the PLC via it's FTP server on a cron based task, do some processing and save data in a SQLite database so the customer can read/view data at any time, export data in an Excel spreadsheet and whatnot. The UI is designed with the help of MetroModernUI library, some stuff from Krypton.Components.Suite, the Excel processing part is done via NPOI library, [this](https://github.com/HenriqueCaires/cron) cron library, a FTP client I found online over the Internet and I don't know from where exactly.. anyway, not taking credit for doing all the stuff. :grin:

### A bit of background
Sometimes around 2018 ~~2019~~ a customer asked us (the company I used to work at the time) for help at his pig ranch that was in dire need of some TLC, aka. some major mechanical changes/upgrades to automate things as much as possible in order to increase overall productivity. Taking out (preferably, but not 100% possible) the human factor out of the equation was the cherry on the cake, as at the time his employees used the old school pencil and a piece of paper method to keep track of what happened in the "system", what food was created at the local mill and where said food was later on distributed. This method prooved to be prone to mistakes, hence the upgrades.
>>>>>>> 4bdb7f9 (Today's changes.)

The customer handled the mechanical aspects (installing rails, silos for forage storage, scales to measure input and output, and so on) while we took care of the automation and logic, specifically tracking the loading and distribution processes. We used a Schneider Electric PLC (a TM221 series device, if I recall correctly) to store data on an SD card in two separate log files, which were written cyclically (meaning older data would eventually be overwritten). One file, _Incarcare.log_, recorded the loading process, while the other, _Descarcare.log_, tracked the unloading. The PLC featured an FTP server, which allowed users with the correct username and password (hard-coded for convenience) to download these files, which were in a raw CSV format (see _Extra_ folder for examples).

<<<<<<< HEAD
**TLDR**: This app was born for two reasons:
The data, meaning records of the forage being filled and emptied from six silos, was generated by the PLC and saved on its SD card. However, since the logs were written cyclically, older data would eventually be overwritten, leading to the loss of important information for the customer, thus it was crucial to save all the records after sanitization of the content.
=======
### **TLDR**:
Started working on this app for two reasons:
- because how was the data saved on the PLC end (cyclic, so records would be overwritten at some point due to space) and because it's in a raw format and would be a hard task for the customer to process the data
- for my pure enjoyment to learn a new programming language.
>>>>>>> 4bdb7f9 (Today's changes.)

For the sake of learning a new programming language, I developed a fully functional app (initially built on .NET Framework version 4) and gave it to them free of charge. The app allowed them to easily retrieve both past and future records from the PLC without much effort on their part. The last time I spoke with them, they were still using the app on a daily basis.

<<<<<<< HEAD
# About the app
In the initial release, I used Visual Studio 2019 Community Edition to create an application that automated the process of retrieving raw logs from the PLC via its FTP server on a cron-based schedule. The logs were then processed, and the data was saved into an SQLite database, allowing the customer to view the information at any time, export it to an Excel spreadsheet, and more. The UI was built using the MetroModernUI library, with additional components from Krypton.Components.Suite. For Excel processing, I used the NPOI library, for scheduling tasks, this [cron library](https://github.com/HenriqueCaires/cron), and for FTP access, a client I found online (though I can’t recall the exact source). I don’t claim full credit for all the components used in this project as not everything was developed by me.

## To do:
- [ ] switch to using the singleton database (created, partially used)
- [ ] switch to FluentFTP to handle the downloads (not implemented cos need to do some testing first)
- [ ] update overall used logic and code
- [ ] ditch NPOI in favor of MiniExcel
- [ ] miscellaneous bug fixes and improvements
- [ ] fix visual artefacts that appeared after the change from .NET v4 to v6
- [ ] maybe switch to WPF and drop WinForms, MetroModernUI and so on

## Done so far:
- [x] drop the SingleInstanceMutex.cs altogether in favor of something a lot easier ([link](https://stackoverflow.com/a/819808))
- [x] switched to records instead of DataTable and major code changes in the logs parsing and saving them to the database
- [x] some stuff I don't remember right now xD
- [x] exposed various previously hard-coded settings into a JSON file
- [x] rebuilt database integrity check and exposed the schemas used in above file
- [x] simplified the logic behind parsing the Transport records
- [x] _trying_ to be more OOP friendly
=======
### Addendum:
- according to the logs in the PLC the first entry is in fact from 24 September 2018, not 2019 as I initially mentioned.

> [!NOTE]
> Apart of fixing bugs or adding new functionality to the application, I also try to align with best practices and community standards as I advance my knowledge of the language. With this in mind I would appreciate any sort of feedback related to the coding style or the application itself. :ok_hand:

### To do:
- [ ] fully switch to WPF since MetroFramework and Krypton.Components are no longer maintained and aren't 100% compatible with .NET 6 and they cause some visual artefacts (look at 'Mesaje' form for example). Progress is slow as I have to change some of the controls to suit my particular needs (file 'wpf layout.png' in 'Extra' folder shows what I've done so far).
- [ ] complete the refactoring the the application where the the UI is mostly involved (considering making a mockup to get this part out of the way)
- [ ] continue crude experiments with SkiaSharp to get some fancy charts (see 'crude bar chart.png' in Extra for one of them)
- [ ] fully transition from NPOI to MiniExcel for handling the export of data from database into an Excel fileF

### Done:
- [x] handling the single-instance application with a simplified and more straightforward solution based on ([this](https://stackoverflow.com/a/819808)) answer on StackOverflow
- [x] transitioned to records from using DataTable, mostly impacting the functionality of the log parsing and saving in the database
- [x] externalized some of the previously hard-coded settings into a JSON file to be more flexible to changes via custom service (for example if the customer wishes to change the the PLC's IP address)
- [x] refactored the code in multiple sections of the application, most notable ones are in the 'transport' logs processing (parsing, filtering, and saving to the database)
- [x] restructured the project into separate folders to improve it's maintainability and readability
- [x] added a simple logging functionality to make debugging easier (to some extent at least)
- [x] implemented a thread-safe singleton pattern for managing database connections (SQLite is used, but can be easily changed)
- [x] use FluentFTP for handling the downloads of the log files from the PLC (not added to the project yet)
>>>>>>> 4bdb7f9 (Today's changes.)
